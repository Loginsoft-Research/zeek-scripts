@load base/protocols/http
@load base/frameworks/notice


module log4j;

export{
	redef enum Notice::Type+={
		Java_downloaded,
		cve_2021_44228_exploit,
	};
	global java_content_pattern:pattern=/java-vm/;
	global java_version_pattern:pattern=/^Java\//;
	global exploit_ldap_pattern: pattern = /jndi:ldap[^}]+:[^}]+/;
}

event http_header(c: connection, is_orig: bool, original_name: string, name: string, value: string)

{

### java download and version check

	if(name == "CONTENT-TYPE" && java_content_pattern in value )
	{
		if(c$http?$user_agent && java_version_pattern in c$http$user_agent)
		{
			local exploit_match=match_pattern(c$http$uri,/Exploit\./);
			if(exploit_match$matched)				
			{
				NOTICE([$note=Java_downloaded,
				$conn=c,
				$msg="Possible log4j cve_2021_44228_exploit"
				]);
			}

		}

	}
# # ldap value confirmation

	if(exploit_ldap_pattern in value)
	{
		NOTICE([$note=cve_2021_44228_exploit,
		$conn=c,
		$msg="Possible log4j cve_2021_44228_exploit",
		$sub=""
		]);
		
	}

}
